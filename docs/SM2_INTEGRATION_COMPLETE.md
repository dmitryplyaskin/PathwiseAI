# Интеграция алгоритма SM-2 для интервального повторения - Улучшенная версия

## Обзор

Система интервального повторения на основе улучшенного алгоритма SM-2 успешно интегрирована в проект PathwiseAI. Система автоматически рассчитывает интервалы повторения уроков на основе результатов тестирования с учётом различных факторов: времени повторения, типа теста и уровня сложности материала.

## Реализованные компоненты

### Backend

#### 1. SM2SpacedRepetitionService (улучшенная версия)

**Файл:** `src/modules/courses/services/sm2-spaced-repetition.service.ts`

Сервис для расчета интервалов повторения по улучшенному алгоритму SM-2:

- Определяет качество ответа по ужесточенным критериям
- Учитывает тип теста (5 vs 10 вопросов) для более строгой оценки
- Корректирует качество на основе времени повторения
- Рассчитывает новый статус урока (NOT_STARTED → LEARNING → MASTERED, с FAILED для очень плохих результатов)
- Ограничивает экспоненциальный рост больших интервалов
- Возвращает дату следующего повторения и фактический интервал
- Использует поле `repetitions` (количество успешных повторений подряд) для каноничных первых интервалов (1 день, затем 6 дней)

#### 2. Обновленный ExamsService

**Файл:** `src/modules/exams/services/exams.service.ts`

Интеграция с SM-2 алгоритмом:

- Добавлен импорт `SM2SpacedRepetitionService`
- Обновлен метод `submitTestResult` для обновления прогресса урока
- Добавлен приватный метод `updateLessonProgress`

#### 3. API endpoint для уроков повторения

**Файл:** `src/modules/courses/controllers/courses.controller.ts`

Новый endpoint:

- `GET /courses/lessons/for-review/:userId` - получение уроков для повторения

#### 4. Метод в LessonsService

**Файл:** `src/modules/courses/services/lessons.service.ts`

Добавлен метод `findLessonsForReview`:

- Фильтрует уроки по дате следующего повторения
- Возвращает только уроки со статусом LEARNING или MASTERED
- Сортирует по дате следующего повторения

### Frontend

#### 1. Типы API

**Файл:** `frontend/src/shared/api/lessons/types.ts`

Добавлен интерфейс `LessonForReview` с полями:

- `next_review_at` - дата следующего повторения
- `ease_factor` - коэффициент легкости
- `interval` - интервал повторения в днях
- `last_reviewed_at` - дата последнего повторения

#### 2. API методы

**Файл:** `frontend/src/shared/api/lessons/api.ts`

Добавлен метод `getLessonsForReview` для получения уроков повторения.

#### 3. Компонент ReviewLessonsList

**Файл:** `frontend/src/widgets/review-lessons/ui/ReviewLessonsList.tsx`

Компонент для отображения уроков повторения:

- Загружает уроки для повторения
- Отображает приоритет (Критично/Важно/Планово)
- Показывает дату следующего повторения
- Позволяет перейти к уроку для повторения
- Обновляется при изменении данных урока

#### 4. Обновленная главная страница

**Файл:** `frontend/src/pages/home/ui/HomePage.tsx`

Главная страница использует данные SM-2, чтобы показывать пользователю приоритеты на день.

- Блок **"Повторить"** использует endpoint `GET /lessons/for-review/:userId` и показывает top-N уроков.
- На главной выводятся счётчики (просрочено/сегодня/скоро) и кнопки **"Начать"** / **"Все"** (страница `/review`).

Подробности по структуре главной: `docs/HOME_PAGE_DASHBOARD.md`.

#### 5. Страница повторения

**Файл:** `frontend/src/pages/review/ui/ReviewPage.tsx`

Новая страница для отображения всех уроков повторения с подробным описанием.

#### 6. Навигация

**Файл:** `frontend/src/app/ui/Layout.tsx`

Добавлена ссылка "Повторение" в главное меню.

#### 7. Маршруты

**Файл:** `frontend/src/app/config/router.tsx`

Добавлен маршрут `/review` для страницы повторения.

#### 8. Обновление TestModal

**Файл:** `frontend/src/widgets/test/ui/TestModal.tsx`

Добавлено событие `lessonUpdated` для обновления данных урока после тестирования.

## Улучшенный алгоритм SM-2

### Логика работы

1. **Определение качества ответа (ужесточенные критерии):**
   - 90-100 баллов → качество 5 (отлично)
   - 80-89 баллов → качество 4 (хорошо)
   - 60-79 баллов → качество 3 (удовлетворительно)
   - 40-59 баллов → качество 2 (плохо)
   - 0-39 баллов → качество 1 (очень плохо)

2. **Учёт типа теста (5 vs 10 вопросов):**
   - Если известны `correctAnswers` и `totalQuestions`, качество определяется **по количеству правильных ответов** (дискретно), что даёт более стабильную оценку при 5/10 вопросах.
   - Если этих данных нет, используется `score` (0..100) по шкале качества.

3. **Учёт времени повторения:**
   - Если повторение прошло **слишком рано** (< 50% от запланированного): качество снижается на 1 (чтобы не “накручивать” интервалы)
   - Если повторение прошло **сильно поздно** (> 200% от запланированного): качество снижается на 1 (или на 2 при очень большой просрочке)

4. **Обновление статуса:**
   - Качество = 1: статус **FAILED** (очень плохой результат)
   - Качество = 2: возврат к статусу **LEARNING**
   - Качество ≥ 3: переход к следующему статусу или остаться в **MASTERED**
   - **FAILED** уроки могут быть пересданы и вернуться к **LEARNING**

5. **Расчет интервала:**
   - Первое успешное повторение: интервал = 1 день
   - Второе успешное повторение: интервал = 6 дней (приближение к классическому SM-2)
   - Дальше: интервал = предыдущий интервал × коэффициент легкости
   - Для очень больших интервалов (> 365 дней): ограничение роста √(EF) вместо EF

6. **Коэффициент легкости:**
   - Увеличивается при хороших ответах
   - Уменьшается при плохих ответах (рассчитывается формулой SM-2)
   - Минимальное значение: 1.3
   - Максимальное значение: не ограничено

## Использование

### Для пользователей

1. **Прохождение теста:** После завершения теста система автоматически обновляет интервалы повторения
2. **Просмотр уроков повторения:** На главной странице отображаются уроки, требующие повторения
3. **Страница повторения:** Переход по ссылке "Повторение" в меню для просмотра всех уроков
4. **Приоритизация:** Уроки отображаются с приоритетом (Критично/Важно/Планово)

### Для разработчиков

1. **API:** Используйте endpoint `/courses/lessons/for-review/:userId` для получения уроков
2. **События:** Слушайте событие `lessonUpdated` для обновления UI
3. **Компоненты:** Используйте `ReviewLessonsList` для отображения уроков повторения

## Тестирование

### Проверка функциональности

1. Создать урок и пройти тест
2. Проверить обновление статуса урока
3. Проверить расчет интервалов повторения
4. Проверить отображение уроков для повторения
5. Проверить работу системы повторения

### Тестовые сценарии

1. **Отличный результат (90+ баллов):**
   - Статус: NOT_STARTED → LEARNING → MASTERED
   - Интервал увеличивается значительно
   - Коэффициент легкости увеличивается

2. **Хороший результат (80-89 баллов):**
   - Статус прогрессирует по цепочке
   - Интервал увеличивается умеренно
   - Коэффициент легкости увеличивается

3. **Удовлетворительный результат (60-79 баллов):**
   - Статус остается или переходит к MASTERED
   - Интервал увеличивается умеренно
   - Коэффициент легкости изменяется незначительно

4. **Плохой результат (40-59 баллов):**
   - Статус: MASTERED → LEARNING
   - Интервал сбрасывается до 1 дня
   - Коэффициент легкости пересчитывается по формуле SM-2

5. **Очень плохой результат (<40 баллов):**
   - Статус: любой → FAILED
   - Интервал сбрасывается до 1 дня
   - Коэффициент легкости пересчитывается по формуле SM-2
   - Урок доступен для повторного прохождения

6. **Детальный тест (10 вопросов) с 80% правильных:**
   - Качество считается по количеству правильных ответов (например, 8/10)
   - Такой результат обычно соответствует “хорошо/удовлетворительно” в зависимости от порогов дискретной шкалы

7. **Повторение слишком рано (<50% времени):**
   - Качество ответа снижается на 1 уровень
   - Более строгие требования к повторению

8. **Повторение слишком поздно (>200% времени):**
   - Качество ответа снижается на 1 уровень (или на 2 при очень большой просрочке)
   - Система учитывает, что повторение было сложнее из-за забывания

## Возможные улучшения

1. **Адаптивные интервалы** - учет времени прохождения теста
2. **Уведомления** - напоминания о необходимости повторения
3. **Аналитика** - статистика эффективности повторений
4. **Настройки пользователя** - возможность изменить параметры SM-2
5. **Экспорт/импорт** - синхронизация с внешними системами

## Заключение

Улучшенная система интервального повторения SM-2 успешно интегрирована и готова к использованию. Она учитывает множество факторов: время повторения, сложность тестов, индивидуальный прогресс пользователя. Система предоставляет более точные и адаптивные интервалы повторения, способствуя максимально эффективному запоминанию материала.

**Ключевые преимущества улучшенной версии:**

- Более справедливая оценка результатов для разных типов тестов
- Адаптация к индивидуальному ритму повторения
- Предотвращение забывания с помощью статуса FAILED
- Ограничение чрезмерного роста интервалов для поддержания регулярности повторений
