# Интеграция алгоритма SM-2 для интервального повторения - Завершено

## Обзор

Система интервального повторения на основе алгоритма SM-2 успешно интегрирована в проект PathwiseAI. Система автоматически рассчитывает интервалы повторения уроков на основе результатов тестирования.

## Реализованные компоненты

### Backend

#### 1. SM2SpacedRepetitionService

**Файл:** `src/modules/courses/services/sm2-spaced-repetition.service.ts`

Сервис для расчета интервалов повторения по алгоритму SM-2:

- Определяет качество ответа по баллу (0-100)
- Рассчитывает новый статус урока (NOT_STARTED → LEARNING → MASTERED)
- Обновляет интервал повторения и коэффициент легкости
- Возвращает дату следующего повторения

#### 2. Обновленный ExamsService

**Файл:** `src/modules/exams/services/exams.service.ts`

Интеграция с SM-2 алгоритмом:

- Добавлен импорт `SM2SpacedRepetitionService`
- Обновлен метод `submitTestResult` для обновления прогресса урока
- Добавлен приватный метод `updateLessonProgress`

#### 3. API endpoint для уроков повторения

**Файл:** `src/modules/courses/controllers/courses.controller.ts`

Новый endpoint:

- `GET /courses/lessons/for-review/:userId` - получение уроков для повторения

#### 4. Метод в LessonsService

**Файл:** `src/modules/courses/services/lessons.service.ts`

Добавлен метод `findLessonsForReview`:

- Фильтрует уроки по дате следующего повторения
- Возвращает только уроки со статусом LEARNING или MASTERED
- Сортирует по дате следующего повторения

### Frontend

#### 1. Типы API

**Файл:** `frontend/src/shared/api/lessons/types.ts`

Добавлен интерфейс `LessonForReview` с полями:

- `next_review_at` - дата следующего повторения
- `ease_factor` - коэффициент легкости
- `interval` - интервал повторения в днях
- `last_reviewed_at` - дата последнего повторения

#### 2. API методы

**Файл:** `frontend/src/shared/api/lessons/api.ts`

Добавлен метод `getLessonsForReview` для получения уроков повторения.

#### 3. Компонент ReviewLessonsList

**Файл:** `frontend/src/widgets/review-lessons/ui/ReviewLessonsList.tsx`

Компонент для отображения уроков повторения:

- Загружает уроки для повторения
- Отображает приоритет (Критично/Важно/Планово)
- Показывает дату следующего повторения
- Позволяет перейти к уроку для повторения
- Обновляется при изменении данных урока

#### 4. Обновленная главная страница

**Файл:** `frontend/src/pages/home/ui/HomePage.tsx`

Заменен статический блок "Требуют повторения" на динамический компонент `ReviewLessonsList`.

#### 5. Страница повторения

**Файл:** `frontend/src/pages/review/ui/ReviewPage.tsx`

Новая страница для отображения всех уроков повторения с подробным описанием.

#### 6. Навигация

**Файл:** `frontend/src/app/ui/Layout.tsx`

Добавлена ссылка "Повторение" в главное меню.

#### 7. Маршруты

**Файл:** `frontend/src/app/config/router.tsx`

Добавлен маршрут `/review` для страницы повторения.

#### 8. Обновление TestModal

**Файл:** `frontend/src/widgets/test/ui/TestModal.tsx`

Добавлено событие `lessonUpdated` для обновления данных урока после тестирования.

## Алгоритм SM-2

### Логика работы

1. **Определение качества ответа:**
   - 85-100 баллов → качество 5 (отлично)
   - 70-84 балла → качество 4 (хорошо)
   - 50-69 баллов → качество 3 (удовлетворительно)
   - 30-49 баллов → качество 2 (плохо)
   - 0-29 баллов → качество 1 (очень плохо)

2. **Обновление статуса:**
   - Качество ≥ 3: переход к следующему статусу или остаться в MASTERED
   - Качество < 3: возврат к статусу LEARNING

3. **Расчет интервала:**
   - Первое повторение: интервал = 1 день
   - Последующие: интервал = предыдущий интервал × коэффициент легкости

4. **Коэффициент легкости:**
   - Увеличивается при хороших ответах
   - Уменьшается при плохих ответах
   - Минимальное значение: 1.3

## Использование

### Для пользователей

1. **Прохождение теста:** После завершения теста система автоматически обновляет интервалы повторения
2. **Просмотр уроков повторения:** На главной странице отображаются уроки, требующие повторения
3. **Страница повторения:** Переход по ссылке "Повторение" в меню для просмотра всех уроков
4. **Приоритизация:** Уроки отображаются с приоритетом (Критично/Важно/Планово)

### Для разработчиков

1. **API:** Используйте endpoint `/courses/lessons/for-review/:userId` для получения уроков
2. **События:** Слушайте событие `lessonUpdated` для обновления UI
3. **Компоненты:** Используйте `ReviewLessonsList` для отображения уроков повторения

## Тестирование

### Проверка функциональности

1. Создать урок и пройти тест
2. Проверить обновление статуса урока
3. Проверить расчет интервалов повторения
4. Проверить отображение уроков для повторения
5. Проверить работу системы повторения

### Тестовые сценарии

1. **Хороший результат теста (85+ баллов):**
   - Статус: NOT_STARTED → LEARNING → MASTERED
   - Интервал увеличивается
   - Коэффициент легкости увеличивается

2. **Плохой результат теста (<30 баллов):**
   - Статус: MASTERED → LEARNING
   - Интервал сбрасывается до 1 дня
   - Коэффициент легкости уменьшается

3. **Средний результат теста (50-70 баллов):**
   - Статус остается или переходит к MASTERED
   - Интервал увеличивается умеренно
   - Коэффициент легкости изменяется незначительно

## Возможные улучшения

1. **Адаптивные интервалы** - учет времени прохождения теста
2. **Уведомления** - напоминания о необходимости повторения
3. **Аналитика** - статистика эффективности повторений
4. **Настройки пользователя** - возможность изменить параметры SM-2
5. **Экспорт/импорт** - синхронизация с внешними системами

## Заключение

Система интервального повторения SM-2 успешно интегрирована и готова к использованию. Она автоматически рассчитывает оптимальные интервалы повторения уроков на основе результатов тестирования пользователей, что способствует более эффективному запоминанию материала.
